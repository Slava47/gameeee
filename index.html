<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Color Blast</title>
<script src="/sdk.js"></script>
<style>
:root {
  --bg-primary: #1a1a2e;
  --bg-secondary: #16213e;
  --bg-card: #0f3460;
  --text-primary: #e8e8e8;
  --text-secondary: #a0a0b0;
  --accent: #e94560;
  --accent2: #533483;
  --radius: 12px;
  --shadow: 0 4px 15px rgba(0,0,0,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
html, body {
  width:100%; height:100%;
  overflow:hidden;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
  color: var(--text-primary);
  touch-action: none;
  user-select: none;
  -webkit-user-select: none;
}
#game-container {
  width:100%; height:100%;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  position:relative;
}

/* Screens */
.screen {
  position:absolute; top:0; left:0; width:100%; height:100%;
  display:none; flex-direction:column;
  align-items:center; justify-content:center;
  padding: 20px;
  z-index: 10;
}
.screen.active { display:flex; }

/* Menu */
#menu-screen {
  background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
}
.game-title {
  font-size: clamp(36px, 8vw, 64px);
  font-weight: 900;
  background: linear-gradient(135deg, #e94560, #533483, #0f3460);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 10px;
  text-align: center;
}
.game-subtitle {
  color: var(--text-secondary);
  font-size: clamp(14px, 3vw, 18px);
  margin-bottom: 40px;
  text-align: center;
}
.menu-tiles {
  display: flex; gap: 8px; margin-bottom: 30px;
}
.menu-tile {
  width: clamp(40px,10vw,60px); height: clamp(40px,10vw,60px);
  border-radius: var(--radius);
  animation: menuFloat 2s ease-in-out infinite;
}
.menu-tile:nth-child(1) { background: linear-gradient(135deg, #FF6B6B, #ee5a5a); animation-delay: 0s; }
.menu-tile:nth-child(2) { background: linear-gradient(135deg, #4ECDC4, #3dbdb4); animation-delay: 0.3s; }
.menu-tile:nth-child(3) { background: linear-gradient(135deg, #FFE66D, #eed55c); animation-delay: 0.6s; }
.menu-tile:nth-child(4) { background: linear-gradient(135deg, #A78BFA, #967ae9); animation-delay: 0.9s; }
.menu-tile:nth-child(5) { background: linear-gradient(135deg, #F093FB, #e082ea); animation-delay: 1.2s; }
@keyframes menuFloat {
  0%,100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-10px) scale(1.05); }
}

.btn {
  padding: 14px 40px;
  border: none; border-radius: 30px;
  font-size: clamp(16px, 3.5vw, 20px);
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  margin: 6px;
  min-width: 200px;
  text-align: center;
}
.btn:active { transform: scale(0.95); }
.btn-primary {
  background: linear-gradient(135deg, var(--accent), #c73e55);
  color: white;
  box-shadow: 0 4px 15px rgba(233,69,96,0.4);
}
.btn-secondary {
  background: linear-gradient(135deg, var(--accent2), #442a6e);
  color: white;
  box-shadow: 0 4px 15px rgba(83,52,131,0.4);
}
.btn-reward {
  background: linear-gradient(135deg, #FFE66D, #f0d040);
  color: #333;
  box-shadow: 0 4px 15px rgba(255,230,109,0.4);
}
.best-score {
  margin-top: 20px;
  color: var(--text-secondary);
  font-size: 16px;
}

/* HUD */
#hud {
  width: 100%;
  padding: 8px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
  z-index: 5;
}
.hud-item {
  text-align: center;
  flex: 1;
}
.hud-label {
  font-size: clamp(10px, 2vw, 12px);
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
}
.hud-value {
  font-size: clamp(18px, 4vw, 24px);
  font-weight: 800;
}
.hud-value.score-val { color: #FFE66D; }
.hud-value.target-val { color: #4ECDC4; }
.hud-value.moves-val { color: #FF6B6B; }
.hud-value.level-val { color: #A78BFA; }
#pause-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: white;
  width: 40px; height: 40px;
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.pause-icon {
  display: flex; gap: 3px;
}
.pause-bar {
  width: 4px; height: 14px;
  background: white; border-radius: 2px;
}

/* Progress bar */
#progress-bar-container {
  width: calc(100% - 24px);
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin: 0 12px 8px;
  flex-shrink: 0;
}
#progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #4ECDC4, #FFE66D);
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 0%;
}

/* Grid */
#grid-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  padding: 8px;
  position: relative;
}
#grid {
  display: grid;
  gap: 4px;
  position: relative;
}
.tile {
  border-radius: var(--radius);
  cursor: pointer;
  transition: transform 0.15s, opacity 0.15s;
  position: relative;
  overflow: hidden;
}
.tile::after {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 40%;
  background: linear-gradient(180deg, rgba(255,255,255,0.2), transparent);
  border-radius: var(--radius) var(--radius) 0 0;
  pointer-events: none;
}
.tile.highlight {
  transform: scale(1.08);
  box-shadow: 0 0 12px rgba(255,255,255,0.3);
}
.tile.clearing {
  animation: tileClear 0.35s ease forwards;
}
@keyframes tileClear {
  0% { transform: scale(1); opacity:1; }
  50% { transform: scale(1.3); opacity:0.7; }
  100% { transform: scale(0); opacity:0; }
}
.tile.falling {
  animation: tileFall 0.3s ease forwards;
}
@keyframes tileFall {
  from { transform: translateY(-100%); opacity: 0.5; }
  to { transform: translateY(0); opacity: 1; }
}
.tile.new-tile {
  animation: tileAppear 0.3s ease forwards;
}
@keyframes tileAppear {
  from { transform: scale(0); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* Floating score */
.float-score {
  position: absolute;
  font-size: 20px;
  font-weight: 900;
  color: #FFE66D;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  pointer-events: none;
  z-index: 20;
  animation: floatUp 1s ease forwards;
}
@keyframes floatUp {
  0% { transform: translateY(0) scale(1); opacity:1; }
  100% { transform: translateY(-60px) scale(1.5); opacity:0; }
}

/* Particles */
.particle {
  position: absolute;
  width: 8px; height: 8px;
  border-radius: 50%;
  pointer-events: none;
  z-index: 15;
  animation: particleBurst 0.6s ease forwards;
}
@keyframes particleBurst {
  0% { transform: translate(0,0) scale(1); opacity:1; }
  100% { transform: translate(var(--px), var(--py)) scale(0); opacity:0; }
}

/* Overlay screens */
#pause-screen, #level-complete-screen, #gameover-screen {
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  z-index: 50;
}
.overlay-card {
  background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
  border-radius: 20px;
  padding: clamp(20px, 5vw, 40px);
  text-align: center;
  box-shadow: var(--shadow);
  max-width: 360px;
  width: 90%;
}
.overlay-title {
  font-size: clamp(24px, 6vw, 36px);
  font-weight: 900;
  margin-bottom: 15px;
}
.overlay-title.complete { color: #4ECDC4; }
.overlay-title.gameover { color: #FF6B6B; }
.overlay-title.paused { color: #A78BFA; }
.overlay-stat {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-size: 16px;
}
.overlay-stat-label { color: var(--text-secondary); }
.overlay-stat-value { font-weight: 700; }
.overlay-buttons { margin-top: 20px; display:flex; flex-direction:column; align-items:center; }

/* Stars for level complete */
.stars-container {
  display: flex; gap: 10px; justify-content: center; margin: 15px 0;
}
.star {
  width: 40px; height: 40px;
  position: relative;
}
.star-shape {
  width: 100%; height: 100%;
}
.star-shape polygon { fill: #555; }
.star.earned .star-shape polygon { fill: #FFE66D; }
.star.earned {
  animation: starPop 0.4s ease;
}
.star:nth-child(2).earned { animation-delay: 0.15s; }
.star:nth-child(3).earned { animation-delay: 0.3s; }
@keyframes starPop {
  0% { transform: scale(0) rotate(-30deg); }
  60% { transform: scale(1.3) rotate(10deg); }
  100% { transform: scale(1) rotate(0); }
}

/* Loading */
#loading-screen {
  background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
  z-index: 100;
}
.loader {
  width: 50px; height: 50px;
  border: 4px solid rgba(255,255,255,0.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 20px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* RTL support */
[dir="rtl"] .hud-item { direction: rtl; }
[dir="rtl"] .overlay-stat { flex-direction: row-reverse; }

/* Game screen */
#game-screen {
  z-index: 1;
  padding: 0;
}
#game-screen.active { display: flex; }
</style>
</head>
<body>
<div id="game-container">

  <!-- Loading Screen -->
  <div id="loading-screen" class="screen active">
    <div class="loader"></div>
    <div id="loading-text">Loading...</div>
  </div>

  <!-- Menu Screen -->
  <div id="menu-screen" class="screen">
    <div class="menu-tiles">
      <div class="menu-tile"></div>
      <div class="menu-tile"></div>
      <div class="menu-tile"></div>
      <div class="menu-tile"></div>
      <div class="menu-tile"></div>
    </div>
    <div class="game-title" id="title-text">Color Blast</div>
    <div class="game-subtitle" id="subtitle-text">Tap groups of same-colored tiles</div>
    <button class="btn btn-primary" id="play-btn">Play</button>
    <button class="btn btn-secondary" id="continue-btn" style="display:none">Continue</button>
    <div class="best-score" id="best-score-text"></div>
  </div>

  <!-- Game Screen -->
  <div id="game-screen" class="screen">
    <div id="hud">
      <div class="hud-item">
        <div class="hud-label" id="hud-score-label">Score</div>
        <div class="hud-value score-val" id="hud-score">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label" id="hud-target-label">Target</div>
        <div class="hud-value target-val" id="hud-target">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label" id="hud-moves-label">Moves</div>
        <div class="hud-value moves-val" id="hud-moves">0</div>
      </div>
      <div class="hud-item">
        <div class="hud-label" id="hud-level-label">Level</div>
        <div class="hud-value level-val" id="hud-level">1</div>
      </div>
      <button id="pause-btn"><div class="pause-icon"><div class="pause-bar"></div><div class="pause-bar"></div></div></button>
    </div>
    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    <div id="grid-container">
      <div id="grid"></div>
    </div>
  </div>

  <!-- Pause Screen -->
  <div id="pause-screen" class="screen">
    <div class="overlay-card">
      <div class="overlay-title paused" id="pause-title">Pause</div>
      <div class="overlay-buttons">
        <button class="btn btn-primary" id="resume-btn">Continue</button>
        <button class="btn btn-secondary" id="pause-menu-btn">Menu</button>
      </div>
    </div>
  </div>

  <!-- Level Complete Screen -->
  <div id="level-complete-screen" class="screen">
    <div class="overlay-card">
      <div class="overlay-title complete" id="complete-title">Level Complete!</div>
      <div class="stars-container" id="stars-container"></div>
      <div id="complete-stats"></div>
      <div class="overlay-buttons">
        <button class="btn btn-primary" id="next-level-btn">Next Level</button>
        <button class="btn btn-secondary" id="complete-menu-btn">Menu</button>
      </div>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div id="gameover-screen" class="screen">
    <div class="overlay-card">
      <div class="overlay-title gameover" id="gameover-title">Game Over</div>
      <div id="gameover-stats"></div>
      <div class="overlay-buttons">
        <button class="btn btn-reward" id="reward-btn">+5 Moves (Ad)</button>
        <button class="btn btn-primary" id="restart-btn">Restart</button>
        <button class="btn btn-secondary" id="gameover-menu-btn">Menu</button>
      </div>
    </div>
  </div>

</div>

<script>
(function() {
'use strict';

// ========== LOCALIZATION ==========
var TRANSLATIONS = {
  ru: {
    title: 'Цветной Взрыв',
    subtitle: 'Нажимайте на группы одинаковых блоков',
    play: 'Играть',
    continue_: 'Продолжить',
    restart: 'Заново',
    menu: 'Меню',
    pause: 'Пауза',
    score: 'Очки',
    level: 'Уровень',
    target: 'Цель',
    best: 'Рекорд',
    moves: 'Ходы',
    levelComplete: 'Уровень пройден!',
    gameOver: 'Игра окончена',
    watchAd: '+5 ходов (Реклама)',
    nextLevel: 'Дальше',
    loading: 'Загрузка...',
    bestScore: 'Лучший: '
  },
  en: {
    title: 'Color Blast',
    subtitle: 'Tap groups of same-colored tiles',
    play: 'Play',
    continue_: 'Continue',
    restart: 'Restart',
    menu: 'Menu',
    pause: 'Pause',
    score: 'Score',
    level: 'Level',
    target: 'Target',
    best: 'Best',
    moves: 'Moves',
    levelComplete: 'Level Complete!',
    gameOver: 'Game Over',
    watchAd: '+5 Moves (Ad)',
    nextLevel: 'Next Level',
    loading: 'Loading...',
    bestScore: 'Best: '
  },
  tr: {
    title: 'Renk Patlamasi',
    subtitle: 'Ayni renkteki gruplara dokunun',
    play: 'Oyna',
    continue_: 'Devam',
    restart: 'Yeniden',
    menu: 'Menu',
    pause: 'Duraklat',
    score: 'Puan',
    level: 'Seviye',
    target: 'Hedef',
    best: 'En Iyi',
    moves: 'Hamle',
    levelComplete: 'Seviye Tamamlandi!',
    gameOver: 'Oyun Bitti',
    watchAd: '+5 Hamle (Reklam)',
    nextLevel: 'Sonraki',
    loading: 'Yukleniyor...',
    bestScore: 'En Iyi: '
  },
  de: {
    title: 'Farbexplosion',
    subtitle: 'Tippe auf Gruppen gleichfarbiger Bloecke',
    play: 'Spielen',
    continue_: 'Weiter',
    restart: 'Neustart',
    menu: 'Menu',
    pause: 'Pause',
    score: 'Punkte',
    level: 'Level',
    target: 'Ziel',
    best: 'Beste',
    moves: 'Zuege',
    levelComplete: 'Level geschafft!',
    gameOver: 'Spiel vorbei',
    watchAd: '+5 Zuege (Werbung)',
    nextLevel: 'Naechstes Level',
    loading: 'Laden...',
    bestScore: 'Beste: '
  },
  fr: {
    title: 'Explosion de Couleurs',
    subtitle: 'Touchez les groupes de blocs identiques',
    play: 'Jouer',
    continue_: 'Continuer',
    restart: 'Recommencer',
    menu: 'Menu',
    pause: 'Pause',
    score: 'Score',
    level: 'Niveau',
    target: 'Objectif',
    best: 'Meilleur',
    moves: 'Coups',
    levelComplete: 'Niveau termine!',
    gameOver: 'Partie terminee',
    watchAd: '+5 Coups (Pub)',
    nextLevel: 'Suivant',
    loading: 'Chargement...',
    bestScore: 'Meilleur: '
  },
  it: {
    title: 'Esplosione di Colori',
    subtitle: 'Tocca i gruppi di blocchi dello stesso colore',
    play: 'Gioca',
    continue_: 'Continua',
    restart: 'Riavvia',
    menu: 'Menu',
    pause: 'Pausa',
    score: 'Punti',
    level: 'Livello',
    target: 'Obiettivo',
    best: 'Migliore',
    moves: 'Mosse',
    levelComplete: 'Livello completato!',
    gameOver: 'Gioco finito',
    watchAd: '+5 Mosse (Video)',
    nextLevel: 'Prossimo',
    loading: 'Caricamento...',
    bestScore: 'Migliore: '
  },
  es: {
    title: 'Explosion de Color',
    subtitle: 'Toca grupos de bloques del mismo color',
    play: 'Jugar',
    continue_: 'Continuar',
    restart: 'Reiniciar',
    menu: 'Menu',
    pause: 'Pausa',
    score: 'Puntos',
    level: 'Nivel',
    target: 'Meta',
    best: 'Mejor',
    moves: 'Movimientos',
    levelComplete: 'Nivel completado!',
    gameOver: 'Fin del juego',
    watchAd: '+5 Movimientos (Video)',
    nextLevel: 'Siguiente',
    loading: 'Cargando...',
    bestScore: 'Mejor: '
  },
  pt: {
    title: 'Explosao de Cores',
    subtitle: 'Toque em grupos de blocos da mesma cor',
    play: 'Jogar',
    continue_: 'Continuar',
    restart: 'Reiniciar',
    menu: 'Menu',
    pause: 'Pausa',
    score: 'Pontos',
    level: 'Nivel',
    target: 'Meta',
    best: 'Melhor',
    moves: 'Jogadas',
    levelComplete: 'Nivel completo!',
    gameOver: 'Fim de jogo',
    watchAd: '+5 Jogadas (Video)',
    nextLevel: 'Proximo',
    loading: 'Carregando...',
    bestScore: 'Melhor: '
  },
  id: {
    title: 'Ledakan Warna',
    subtitle: 'Ketuk kelompok blok berwarna sama',
    play: 'Main',
    continue_: 'Lanjut',
    restart: 'Ulang',
    menu: 'Menu',
    pause: 'Jeda',
    score: 'Skor',
    level: 'Level',
    target: 'Target',
    best: 'Terbaik',
    moves: 'Langkah',
    levelComplete: 'Level Selesai!',
    gameOver: 'Permainan Berakhir',
    watchAd: '+5 Langkah (Iklan)',
    nextLevel: 'Berikutnya',
    loading: 'Memuat...',
    bestScore: 'Terbaik: '
  },
  ar: {
    title: 'انفجار الالوان',
    subtitle: 'انقر على مجموعات البلوكات المتشابهة',
    play: 'العب',
    continue_: 'استمر',
    restart: 'اعادة',
    menu: 'القائمة',
    pause: 'ايقاف',
    score: 'النقاط',
    level: 'المستوى',
    target: 'الهدف',
    best: 'الافضل',
    moves: 'الحركات',
    levelComplete: 'اكتمل المستوى!',
    gameOver: 'انتهت اللعبة',
    watchAd: '+5 حركات (اعلان)',
    nextLevel: 'التالي',
    loading: '...جار التحميل',
    bestScore: 'الافضل: '
  },
  ja: {
    title: 'Color Blast',
    subtitle: '同じ色のグループをタップ',
    play: 'プレイ',
    continue_: '続ける',
    restart: 'やり直し',
    menu: 'メニュー',
    pause: '一時停止',
    score: 'スコア',
    level: 'レベル',
    target: '目標',
    best: 'ベスト',
    moves: '手数',
    levelComplete: 'レベルクリア!',
    gameOver: 'ゲームオーバー',
    watchAd: '+5手 (広告)',
    nextLevel: '次へ',
    loading: '読み込み中...',
    bestScore: 'ベスト: '
  },
  ko: {
    title: 'Color Blast',
    subtitle: '같은 색 그룹을 탭하세요',
    play: '플레이',
    continue_: '계속',
    restart: '다시 시작',
    menu: '메뉴',
    pause: '일시정지',
    score: '점수',
    level: '레벨',
    target: '목표',
    best: '최고',
    moves: '이동',
    levelComplete: '레벨 완료!',
    gameOver: '게임 오버',
    watchAd: '+5회 (광고)',
    nextLevel: '다음',
    loading: '로딩 중...',
    bestScore: '최고: '
  },
  zh: {
    title: 'Color Blast',
    subtitle: '点击相同颜色的方块组',
    play: '开始',
    continue_: '继续',
    restart: '重新开始',
    menu: '菜单',
    pause: '暂停',
    score: '分数',
    level: '关卡',
    target: '目标',
    best: '最佳',
    moves: '步数',
    levelComplete: '关卡完成!',
    gameOver: '游戏结束',
    watchAd: '+5步 (广告)',
    nextLevel: '下一关',
    loading: '加载中...',
    bestScore: '最佳: '
  }
};

var currentLang = 'en';
var ysdk = null;
var player = null;

function t(key) {
  var lang = TRANSLATIONS[currentLang] || TRANSLATIONS.en;
  return lang[key] || TRANSLATIONS.en[key] || key;
}

function setLanguage(lang) {
  currentLang = TRANSLATIONS[lang] ? lang : 'en';
  if (lang === 'ar') {
    document.documentElement.setAttribute('dir', 'rtl');
  } else {
    document.documentElement.removeAttribute('dir');
  }
  updateAllText();
}

function updateAllText() {
  setText('title-text', t('title'));
  setText('subtitle-text', t('subtitle'));
  setText('play-btn', t('play'));
  setText('continue-btn', t('continue_'));
  setText('resume-btn', t('continue_'));
  setText('pause-title', t('pause'));
  setText('pause-menu-btn', t('menu'));
  setText('complete-menu-btn', t('menu'));
  setText('gameover-menu-btn', t('menu'));
  setText('next-level-btn', t('nextLevel'));
  setText('restart-btn', t('restart'));
  setText('reward-btn', t('watchAd'));
  setText('hud-score-label', t('score'));
  setText('hud-target-label', t('target'));
  setText('hud-moves-label', t('moves'));
  setText('hud-level-label', t('level'));
  setText('loading-text', t('loading'));
}

function setText(id, text) {
  var el = document.getElementById(id);
  if (el) el.textContent = text;
}

// ========== AUDIO ==========
var audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    } catch(e) { /* no audio */ }
  }
  return audioCtx;
}

function playSound(freq, duration, type, vol) {
  var ctx = getAudioCtx();
  if (!ctx) return;
  try {
    var osc = ctx.createOscillator();
    var gain = ctx.createGain();
    osc.type = type || 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(vol || 0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (duration || 0.2));
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + (duration || 0.2));
  } catch(e) {}
}

function playClearSound(groupSize) {
  var baseFreq = 400 + Math.min(groupSize, 10) * 50;
  playSound(baseFreq, 0.15, 'sine', 0.12);
  setTimeout(function() { playSound(baseFreq * 1.25, 0.15, 'sine', 0.1); }, 60);
  if (groupSize >= 5) {
    setTimeout(function() { playSound(baseFreq * 1.5, 0.2, 'triangle', 0.08); }, 120);
  }
}

function playMenuSound() { playSound(520, 0.1, 'sine', 0.1); }
function playLevelCompleteSound() {
  playSound(523, 0.15, 'sine', 0.12);
  setTimeout(function() { playSound(659, 0.15, 'sine', 0.12); }, 100);
  setTimeout(function() { playSound(784, 0.25, 'sine', 0.12); }, 200);
}
function playGameOverSound() {
  playSound(400, 0.2, 'sawtooth', 0.08);
  setTimeout(function() { playSound(300, 0.3, 'sawtooth', 0.06); }, 150);
}

// ========== TILE COLORS ==========
var TILE_COLORS = [
  { bg: 'linear-gradient(135deg, #FF6B6B, #ee5252)', solid: '#FF6B6B' },
  { bg: 'linear-gradient(135deg, #4ECDC4, #38b2a9)', solid: '#4ECDC4' },
  { bg: 'linear-gradient(135deg, #FFE66D, #f0d040)', solid: '#FFE66D' },
  { bg: 'linear-gradient(135deg, #A78BFA, #8b6fe0)', solid: '#A78BFA' },
  { bg: 'linear-gradient(135deg, #F093FB, #d870e8)', solid: '#F093FB' },
  { bg: 'linear-gradient(135deg, #6BCB77, #52b25e)', solid: '#6BCB77' }
];

// ========== GAME STATE ==========
var game = {
  cols: 8,
  rows: 10,
  grid: [],
  score: 0,
  level: 1,
  moves: 30,
  targetScore: 500,
  bestScore: 0,
  numColors: 4,
  isPlaying: false,
  isPaused: false,
  isAnimating: false,
  hasProgress: false,
  rewardUsed: false
};

var defaultFlags = {
  baseMovesPerLevel: '30',
  minMovesPerLevel: '15',
  moveDecreasePerLevel: '1'
};
var remoteFlags = {};

// ========== SDK INTEGRATION ==========
function initSDK() {
  if (typeof YaGames === 'undefined') {
    console.log('YaGames SDK not available, running in local mode');
    onSDKReady();
    return;
  }
  try {
    YaGames.init().then(function(sdk) {
      ysdk = sdk;
      try {
        var lang = ysdk.environment.i18n.lang;
        setLanguage(lang);
      } catch(e) {}
      try {
        var di = ysdk.deviceInfo;
        if (di && di.type === 'mobile') {
          game.cols = 8;
          game.rows = 10;
        } else {
          game.cols = 10;
          game.rows = 12;
        }
      } catch(e) {}
      try {
        ysdk.getFlags({ defaultFlags: defaultFlags }).then(function(flags) {
          remoteFlags = flags;
        }).catch(function() {});
      } catch(e) {}
      loadPlayerData().then(function() {
        onSDKReady();
      });
    }).catch(function(err) {
      console.error('SDK init error:', err);
      onSDKReady();
    });
  } catch(e) {
    console.error('SDK init exception:', e);
    onSDKReady();
  }
}

function loadPlayerData() {
  return new Promise(function(resolve) {
    if (!ysdk) { resolve(); return; }
    try {
      ysdk.getPlayer({ scopes: false }).then(function(p) {
        player = p;
        return player.getData(['bestScore', 'level']);
      }).then(function(data) {
        if (data && data.bestScore) game.bestScore = data.bestScore;
        if (data && data.level && data.level > 1) game.hasProgress = true;
        resolve();
      }).catch(function() { resolve(); });
    } catch(e) { resolve(); }
  });
}

function savePlayerData() {
  if (!player) return;
  try {
    player.setData({
      bestScore: game.bestScore,
      level: game.level
    }).catch(function() {});
  } catch(e) {}
}

function showInterstitialAd() {
  return new Promise(function(resolve) {
    if (!ysdk) { resolve(); return; }
    try {
      gameplayStop();
      ysdk.adv.showFullscreenAdv({
        callbacks: {
          onClose: function() {
            gameplayStart();
            resolve();
          },
          onError: function() {
            gameplayStart();
            resolve();
          }
        }
      });
    } catch(e) {
      gameplayStart();
      resolve();
    }
  });
}

function showRewardedAd() {
  return new Promise(function(resolve) {
    if (!ysdk) { resolve(true); return; }
    try {
      gameplayStop();
      var rewarded = false;
      ysdk.adv.showRewardedVideo({
        callbacks: {
          onRewarded: function() {
            rewarded = true;
          },
          onClose: function() {
            gameplayStart();
            resolve(rewarded);
          },
          onError: function() {
            gameplayStart();
            resolve(false);
          }
        }
      });
    } catch(e) {
      gameplayStart();
      resolve(false);
    }
  });
}

function gameplayStart() {
  try { ysdk?.features?.GameplayAPI?.start(); } catch(e) {}
}

function gameplayStop() {
  try { ysdk?.features?.GameplayAPI?.stop(); } catch(e) {}
}

function onSDKReady() {
  try { ysdk?.features?.LoadingAPI?.ready(); } catch(e) {}
  detectDevice();
  updateAllText();
  showScreen('menu-screen');
  updateBestScore();
}

// ========== DEVICE DETECTION ==========
function detectDevice() {
  var isMobile = window.innerWidth < 600 ||
    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if (isMobile) {
    game.cols = 8;
    game.rows = 10;
  } else {
    game.cols = 10;
    game.rows = 12;
  }
}

// ========== SCREENS ==========
function showScreen(id) {
  var screens = document.querySelectorAll('.screen');
  for (var i = 0; i < screens.length; i++) {
    screens[i].classList.remove('active');
  }
  var screen = document.getElementById(id);
  if (screen) screen.classList.add('active');
  if (id === 'game-screen') {
    document.getElementById('game-screen').classList.add('active');
  }
}

function updateBestScore() {
  var el = document.getElementById('best-score-text');
  if (el) {
    el.textContent = game.bestScore > 0 ? t('bestScore') + game.bestScore : '';
  }
  var cb = document.getElementById('continue-btn');
  if (cb) cb.style.display = game.hasProgress ? 'inline-block' : 'none';
}

// ========== GAME LOGIC ==========
function getNumColors(level) {
  if (level <= 3) return 4;
  if (level <= 7) return 5;
  return 6;
}

function getMovesForLevel(level) {
  var base = parseInt(remoteFlags.baseMovesPerLevel || defaultFlags.baseMovesPerLevel);
  var dec = parseInt(remoteFlags.moveDecreasePerLevel || defaultFlags.moveDecreasePerLevel);
  var min = parseInt(remoteFlags.minMovesPerLevel || defaultFlags.minMovesPerLevel);
  return Math.max(min, base - (level - 1) * dec);
}

function getTargetScore(level) {
  return level * 500;
}

function startGame(level) {
  game.level = level || 1;
  game.score = 0;
  game.numColors = getNumColors(game.level);
  game.moves = getMovesForLevel(game.level);
  game.targetScore = getTargetScore(game.level);
  game.isPlaying = true;
  game.isPaused = false;
  game.isAnimating = false;
  game.rewardUsed = false;

  detectDevice();
  initGrid();
  renderGrid();
  updateHUD();
  showScreen('game-screen');
  gameplayStart();
}

function initGrid() {
  game.grid = [];
  for (var r = 0; r < game.rows; r++) {
    game.grid[r] = [];
    for (var c = 0; c < game.cols; c++) {
      game.grid[r][c] = Math.floor(Math.random() * game.numColors);
    }
  }
  if (!hasValidMoves()) {
    shuffleGrid();
  }
}

function renderGrid() {
  var gridEl = document.getElementById('grid');
  var container = document.getElementById('grid-container');
  var containerW = container.clientWidth - 16;
  var containerH = container.clientHeight - 16;

  var tileSize = Math.floor(Math.min(containerW / game.cols, containerH / game.rows)) - 4;
  tileSize = Math.max(tileSize, 28);
  tileSize = Math.min(tileSize, 60);

  gridEl.style.gridTemplateColumns = 'repeat(' + game.cols + ', ' + tileSize + 'px)';
  gridEl.style.gridTemplateRows = 'repeat(' + game.rows + ', ' + tileSize + 'px)';
  gridEl.innerHTML = '';

  for (var r = 0; r < game.rows; r++) {
    for (var c = 0; c < game.cols; c++) {
      var tile = document.createElement('div');
      tile.className = 'tile';
      tile.dataset.row = r;
      tile.dataset.col = c;
      var colorIdx = game.grid[r][c];
      if (colorIdx >= 0 && colorIdx < TILE_COLORS.length) {
        tile.style.background = TILE_COLORS[colorIdx].bg;
      }
      tile.style.width = tileSize + 'px';
      tile.style.height = tileSize + 'px';
      gridEl.appendChild(tile);
    }
  }
}

function getTileElement(r, c) {
  return document.querySelector('.tile[data-row="' + r + '"][data-col="' + c + '"]');
}

function updateHUD() {
  setText('hud-score', game.score.toString());
  setText('hud-target', game.targetScore.toString());
  setText('hud-moves', game.moves.toString());
  setText('hud-level', game.level.toString());

  var pct = Math.min(100, Math.floor(game.score / game.targetScore * 100));
  var bar = document.getElementById('progress-bar');
  if (bar) bar.style.width = pct + '%';
}

// ========== TILE MATCHING ==========
function getGroup(row, col) {
  var color = game.grid[row][col];
  if (color < 0) return [];
  var visited = {};
  var group = [];
  var stack = [[row, col]];

  while (stack.length > 0) {
    var pos = stack.pop();
    var r = pos[0], c = pos[1];
    var key = r + ',' + c;
    if (visited[key]) continue;
    if (r < 0 || r >= game.rows || c < 0 || c >= game.cols) continue;
    if (game.grid[r][c] !== color) continue;
    visited[key] = true;
    group.push({ r: r, c: c });
    stack.push([r-1, c]);
    stack.push([r+1, c]);
    stack.push([r, c-1]);
    stack.push([r, c+1]);
  }
  return group;
}

function hasValidMoves() {
  for (var r = 0; r < game.rows; r++) {
    for (var c = 0; c < game.cols; c++) {
      if (game.grid[r][c] >= 0) {
        var g = getGroup(r, c);
        if (g.length >= 2) return true;
      }
    }
  }
  return false;
}

function shuffleGrid() {
  var tiles = [];
  for (var r = 0; r < game.rows; r++) {
    for (var c = 0; c < game.cols; c++) {
      tiles.push(game.grid[r][c]);
    }
  }
  // Fisher-Yates shuffle
  for (var i = tiles.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = tiles[i];
    tiles[i] = tiles[j];
    tiles[j] = tmp;
  }
  var idx = 0;
  for (var r2 = 0; r2 < game.rows; r2++) {
    for (var c2 = 0; c2 < game.cols; c2++) {
      game.grid[r2][c2] = tiles[idx++];
    }
  }
  if (!hasValidMoves()) {
    // Regenerate if still no moves
    initGrid();
  }
  renderGrid();
}

function highlightGroup(group) {
  clearHighlights();
  for (var i = 0; i < group.length; i++) {
    var el = getTileElement(group[i].r, group[i].c);
    if (el) el.classList.add('highlight');
  }
}

function clearHighlights() {
  var highlighted = document.querySelectorAll('.tile.highlight');
  for (var i = 0; i < highlighted.length; i++) {
    highlighted[i].classList.remove('highlight');
  }
}

function handleTileClick(row, col) {
  if (!game.isPlaying || game.isPaused || game.isAnimating) return;
  if (game.moves <= 0) return;

  var group = getGroup(row, col);
  if (group.length < 2) return;

  game.isAnimating = true;
  game.moves--;

  // Calculate score
  var points = group.length * group.length * 10 * game.level;
  game.score += points;

  // Update best score
  if (game.score > game.bestScore) {
    game.bestScore = game.score;
  }

  playClearSound(group.length);

  // Show floating score
  var firstTile = getTileElement(group[0].r, group[0].c);
  if (firstTile) {
    showFloatingScore(firstTile, points);
  }

  // Spawn particles for big combos
  if (group.length >= 4) {
    var groupColorIdx = game.grid[group[0].r][group[0].c];
    spawnParticles(group, groupColorIdx);
  }

  // Animate clearing
  for (var i = 0; i < group.length; i++) {
    var el = getTileElement(group[i].r, group[i].c);
    if (el) el.classList.add('clearing');
    game.grid[group[i].r][group[i].c] = -1;
  }

  updateHUD();

  setTimeout(function() {
    applyGravity();
    fillEmpty();
    renderGrid();

    setTimeout(function() {
      if (!hasValidMoves()) {
        shuffleGrid();
      }

      game.isAnimating = false;

      // Check win/lose
      if (game.score >= game.targetScore) {
        onLevelComplete();
      } else if (game.moves <= 0) {
        onGameOver();
      }
    }, 100);
  }, 350);
}

function applyGravity() {
  for (var c = 0; c < game.cols; c++) {
    var writeRow = game.rows - 1;
    for (var r = game.rows - 1; r >= 0; r--) {
      if (game.grid[r][c] >= 0) {
        game.grid[writeRow][c] = game.grid[r][c];
        if (writeRow !== r) {
          game.grid[r][c] = -1;
        }
        writeRow--;
      }
    }
    // Fill empty top cells
    for (var r2 = writeRow; r2 >= 0; r2--) {
      game.grid[r2][c] = -1;
    }
  }
}

function fillEmpty() {
  for (var r = 0; r < game.rows; r++) {
    for (var c = 0; c < game.cols; c++) {
      if (game.grid[r][c] < 0) {
        game.grid[r][c] = Math.floor(Math.random() * game.numColors);
      }
    }
  }
}

// ========== VISUAL EFFECTS ==========
function showFloatingScore(anchor, points) {
  var rect = anchor.getBoundingClientRect();
  var el = document.createElement('div');
  el.className = 'float-score';
  el.textContent = '+' + points;
  el.style.left = rect.left + rect.width / 2 - 20 + 'px';
  el.style.top = rect.top + 'px';
  document.body.appendChild(el);
  setTimeout(function() { el.remove(); }, 1000);
}

function spawnParticles(group, colorIdx) {
  var gridEl = document.getElementById('grid');
  var gridRect = gridEl.getBoundingClientRect();
  var color = TILE_COLORS[Math.abs(colorIdx || 0) % TILE_COLORS.length].solid;

  for (var i = 0; i < Math.min(group.length, 8); i++) {
    var tile = getTileElement(group[i].r, group[i].c);
    if (!tile) continue;
    var tileRect = tile.getBoundingClientRect();

    for (var j = 0; j < 3; j++) {
      var p = document.createElement('div');
      p.className = 'particle';
      p.style.background = color;
      p.style.left = (tileRect.left - gridRect.left + tileRect.width / 2) + 'px';
      p.style.top = (tileRect.top - gridRect.top + tileRect.height / 2) + 'px';
      var angle = Math.random() * Math.PI * 2;
      var dist = 30 + Math.random() * 50;
      p.style.setProperty('--px', Math.cos(angle) * dist + 'px');
      p.style.setProperty('--py', Math.sin(angle) * dist + 'px');
      gridEl.appendChild(p);
      (function(particle) {
        setTimeout(function() { particle.remove(); }, 600);
      })(p);
    }
  }
}

// ========== GAME EVENTS ==========
function onLevelComplete() {
  game.isPlaying = false;
  gameplayStop();
  playLevelCompleteSound();

  // Calculate stars
  var ratio = game.score / game.targetScore;
  var stars = ratio >= 2 ? 3 : (ratio >= 1.5 ? 2 : 1);

  // Stars
  var starsEl = document.getElementById('stars-container');
  starsEl.innerHTML = '';
  for (var i = 0; i < 3; i++) {
    var starDiv = document.createElement('div');
    starDiv.className = 'star' + (i < stars ? ' earned' : '');
    starDiv.innerHTML = '<svg class="star-shape" viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 18.5,21 12,17 5.5,21 7,14 2,9 9,9"/></svg>';
    starsEl.appendChild(starDiv);
  }

  // Stats
  var statsEl = document.getElementById('complete-stats');
  statsEl.innerHTML = '';
  addStat(statsEl, t('score'), game.score);
  addStat(statsEl, t('target'), game.targetScore);
  addStat(statsEl, t('moves'), game.moves);

  setText('complete-title', t('levelComplete'));
  savePlayerData();
  game.hasProgress = true;

  showScreen('level-complete-screen');
}

function onGameOver() {
  game.isPlaying = false;
  gameplayStop();
  playGameOverSound();

  var statsEl = document.getElementById('gameover-stats');
  statsEl.innerHTML = '';
  addStat(statsEl, t('score'), game.score);
  addStat(statsEl, t('target'), game.targetScore);
  addStat(statsEl, t('level'), game.level);
  if (game.bestScore > 0) addStat(statsEl, t('best'), game.bestScore);

  setText('gameover-title', t('gameOver'));

  var rewardBtn = document.getElementById('reward-btn');
  if (rewardBtn) rewardBtn.style.display = game.rewardUsed ? 'none' : 'inline-block';

  savePlayerData();
  showScreen('gameover-screen');
}

function addStat(container, label, value) {
  var div = document.createElement('div');
  div.className = 'overlay-stat';
  var l = document.createElement('span');
  l.className = 'overlay-stat-label';
  l.textContent = label;
  var v = document.createElement('span');
  v.className = 'overlay-stat-value';
  v.textContent = value;
  div.appendChild(l);
  div.appendChild(v);
  container.appendChild(div);
}

// ========== EVENT HANDLERS ==========
function setupEvents() {
  // Grid interaction
  var gridEl = document.getElementById('grid');
  var hoveredGroup = [];

  gridEl.addEventListener('click', function(e) {
    var tile = e.target.closest('.tile');
    if (!tile) return;
    var row = parseInt(tile.dataset.row);
    var col = parseInt(tile.dataset.col);
    handleTileClick(row, col);
  });

  gridEl.addEventListener('touchstart', function(e) {
    e.preventDefault();
  }, { passive: false });

  gridEl.addEventListener('mouseover', function(e) {
    if (!game.isPlaying || game.isAnimating) return;
    var tile = e.target.closest('.tile');
    if (!tile) { clearHighlights(); return; }
    var row = parseInt(tile.dataset.row);
    var col = parseInt(tile.dataset.col);
    var group = getGroup(row, col);
    if (group.length >= 2) {
      highlightGroup(group);
    } else {
      clearHighlights();
    }
  });

  gridEl.addEventListener('mouseleave', function() {
    clearHighlights();
  });

  // Buttons
  document.getElementById('play-btn').addEventListener('click', function() {
    playMenuSound();
    startGame(1);
  });

  document.getElementById('continue-btn').addEventListener('click', function() {
    playMenuSound();
    startGame(game.level > 1 ? game.level : 1);
  });

  document.getElementById('pause-btn').addEventListener('click', function() {
    if (!game.isPlaying) return;
    game.isPaused = true;
    gameplayStop();
    showScreen('pause-screen');
  });

  document.getElementById('resume-btn').addEventListener('click', function() {
    playMenuSound();
    game.isPaused = false;
    showScreen('game-screen');
    gameplayStart();
  });

  document.getElementById('pause-menu-btn').addEventListener('click', function() {
    playMenuSound();
    game.isPlaying = false;
    game.isPaused = false;
    updateBestScore();
    showScreen('menu-screen');
  });

  document.getElementById('next-level-btn').addEventListener('click', function() {
    playMenuSound();
    showInterstitialAd().then(function() {
      startGame(game.level + 1);
    });
  });

  document.getElementById('complete-menu-btn').addEventListener('click', function() {
    playMenuSound();
    updateBestScore();
    showScreen('menu-screen');
  });

  document.getElementById('restart-btn').addEventListener('click', function() {
    playMenuSound();
    startGame(game.level);
  });

  document.getElementById('gameover-menu-btn').addEventListener('click', function() {
    playMenuSound();
    updateBestScore();
    showScreen('menu-screen');
  });

  document.getElementById('reward-btn').addEventListener('click', function() {
    showRewardedAd().then(function(rewarded) {
      if (rewarded) {
        game.rewardUsed = true;
        game.moves += 5;
        game.isPlaying = true;
        updateHUD();
        showScreen('game-screen');
        gameplayStart();
      }
    });
  });

  // Prevent context menu
  document.addEventListener('contextmenu', function(e) { e.preventDefault(); });

  // Handle resize
  var resizeTimer;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
      if (game.isPlaying && !game.isPaused) {
        detectDevice();
        renderGrid();
      }
    }, 250);
  });

  // Handle visibility change for pause
  document.addEventListener('visibilitychange', function() {
    if (document.hidden && game.isPlaying && !game.isPaused) {
      game.isPaused = true;
      gameplayStop();
      showScreen('pause-screen');
    }
  });
}

// ========== INIT ==========
function init() {
  setupEvents();
  initSDK();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

})();
</script>
</body>
</html>
